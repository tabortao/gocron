name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.23'

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'yarn'
        cache-dependency-path: web/vue/yarn.lock

    - name: Install frontend dependencies
      run: |
        cd web/vue
        yarn install --frozen-lockfile

    - name: Build frontend
      run: make build-vue

    - name: Generate static assets
      run: |
        go install github.com/rakyll/statik@latest
        go generate ./...

    - name: Build packages for all platforms
      run: |
        chmod +x package.sh
        bash ./package.sh -p "linux,darwin,windows" -a "amd64,arm64"

    - name: Generate release notes
      id: release_notes
      run: |
        # èŽ·å–å½“å‰tagå’Œä¸Šä¸€ä¸ªtag
        CURRENT_TAG=${GITHUB_REF#refs/tags/}
        PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD~1 2>/dev/null || echo "")
        
        # ç”Ÿæˆå˜æ›´æ—¥å¿—
        echo "## ðŸš€ What's New in $CURRENT_TAG" > release_notes.md
        echo "" >> release_notes.md
        
        if [ -n "$PREVIOUS_TAG" ]; then
          echo "### ðŸ“ Changes since $PREVIOUS_TAG:" >> release_notes.md
          echo "" >> release_notes.md
          
          # èŽ·å–æäº¤ä¿¡æ¯å¹¶åˆ†ç±»
          git log --pretty=format:"- %s" $PREVIOUS_TAG..HEAD | grep -E "^- feat" | sed 's/^- feat/âœ¨ **Feature**:/' >> release_notes.md || true
          git log --pretty=format:"- %s" $PREVIOUS_TAG..HEAD | grep -E "^- fix" | sed 's/^- fix/ðŸ› **Fix**:/' >> release_notes.md || true
          git log --pretty=format:"- %s" $PREVIOUS_TAG..HEAD | grep -E "^- docs" | sed 's/^- docs/ðŸ“š **Docs**:/' >> release_notes.md || true
          git log --pretty=format:"- %s" $PREVIOUS_TAG..HEAD | grep -E "^- refactor" | sed 's/^- refactor/â™»ï¸ **Refactor**:/' >> release_notes.md || true
          git log --pretty=format:"- %s" $PREVIOUS_TAG..HEAD | grep -E "^- perf" | sed 's/^- perf/âš¡ **Performance**:/' >> release_notes.md || true
          git log --pretty=format:"- %s" $PREVIOUS_TAG..HEAD | grep -vE "^- (feat|fix|docs|refactor|perf)" | sed 's/^- /ðŸ”§ **Other**: /' >> release_notes.md || true
        else
          echo "ðŸŽ‰ Initial release of gocron - A lightweight cron task management system" >> release_notes.md
        fi
        
        echo "" >> release_notes.md
        echo "## ðŸ“¦ Downloads" >> release_notes.md
        echo "" >> release_notes.md
        echo "Choose the appropriate package for your platform:" >> release_notes.md
        echo "" >> release_notes.md
        echo "### gocron (Web Server)" >> release_notes.md
        echo "- **Linux AMD64**: \`gocron-${CURRENT_TAG}-linux-amd64.tar.gz\`" >> release_notes.md
        echo "- **Linux ARM64**: \`gocron-${CURRENT_TAG}-linux-arm64.tar.gz\`" >> release_notes.md
        echo "- **macOS AMD64**: \`gocron-${CURRENT_TAG}-darwin-amd64.tar.gz\`" >> release_notes.md
        echo "- **macOS ARM64**: \`gocron-${CURRENT_TAG}-darwin-arm64.tar.gz\`" >> release_notes.md
        echo "- **Windows AMD64**: \`gocron-${CURRENT_TAG}-windows-amd64.zip\`" >> release_notes.md
        echo "- **Windows ARM64**: \`gocron-${CURRENT_TAG}-windows-arm64.zip\`" >> release_notes.md
        echo "" >> release_notes.md
        echo "### gocron-node (Task Agent)" >> release_notes.md
        echo "- **Linux AMD64**: \`gocron-node-${CURRENT_TAG}-linux-amd64.tar.gz\`" >> release_notes.md
        echo "- **Linux ARM64**: \`gocron-node-${CURRENT_TAG}-linux-arm64.tar.gz\`" >> release_notes.md
        echo "- **macOS AMD64**: \`gocron-node-${CURRENT_TAG}-darwin-amd64.tar.gz\`" >> release_notes.md
        echo "- **macOS ARM64**: \`gocron-node-${CURRENT_TAG}-darwin-arm64.tar.gz\`" >> release_notes.md
        echo "- **Windows AMD64**: \`gocron-node-${CURRENT_TAG}-windows-amd64.zip\`" >> release_notes.md
        echo "- **Windows ARM64**: \`gocron-node-${CURRENT_TAG}-windows-arm64.zip\`" >> release_notes.md
        echo "" >> release_notes.md
        echo "## ðŸš€ Quick Start" >> release_notes.md
        echo "" >> release_notes.md
        echo "1. Download the appropriate packages for your platform" >> release_notes.md
        echo "2. Extract the archives" >> release_notes.md
        echo "3. Run \`./gocron web\` to start the web server" >> release_notes.md
        echo "4. Run \`./gocron-node\` to start the task agent" >> release_notes.md
        echo "5. Visit http://localhost:5920 to access the web interface" >> release_notes.md
        echo "" >> release_notes.md
        echo "For detailed installation and configuration instructions, please refer to the [README](https://github.com/gocronx-team/gocron/blob/main/README.md)." >> release_notes.md

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        body_path: release_notes.md
        files: |
          gocron-package/*.tar.gz
          gocron-package/*.zip
          gocron-node-package/*.tar.gz
          gocron-node-package/*.zip
        draft: false
        prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') || contains(github.ref, 'rc') }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}