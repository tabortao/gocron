# 2026-02-11 NAS 偶发“部分运行”排查与改进计划

## 问题现象

- 项目部署在 NAS 中，正常运行一段时间后变成“部分运行”（部分功能/接口异常或不可用）。
- 重启后恢复正常。

## 目标

- 给出可操作的定位路径：能把问题归类到「数据库」「gRPC/worker 连接」「资源/宿主机」「文件系统/存储」之一。
- 在代码侧补齐必要的自检与诊断信息，让下次复现时不靠“重启碰运气”。

## 排查优先级（从最可能到较少见）

### 1) 资源与宿主机问题（NAS 场景高发）

- 检查容器是否发生 OOM / 重启 / 被系统杀进程：
  - Docker 事件、容器重启次数、NAS 系统日志（尤其是 OOM killer）。
- 检查磁盘空间/ inode、挂载卷是否变为只读、磁盘 I/O 是否长期 100%：
  - 数据库文件（SQLite）或日志文件写入异常会导致接口“部分可用”。

### 2) 数据库可用性问题

- 若使用 MySQL/PostgreSQL：
  - 网络抖动后连接可能进入异常状态但进程不退出，重启后恢复。
- 若使用 SQLite 且 DB 文件位于网络盘/NFS/SMB：
  - 文件锁/一致性语义不稳定，可能出现间歇性“锁住/写失败/超时”，重启后暂时缓解。

### 3) gRPC/worker 连接问题（“部分运行”非常像这一类）

- master 与 worker 之间的 gRPC 连接在网络抖动/worker 重启后变坏，但连接池未及时重建：
  - 表现：Web UI 正常，任务执行/主机 ping/部分 RPC 功能异常；重启 master 后恢复。

## 代码侧改进项

### A. gRPC 连接池自愈

- 当 RPC 返回 `Unavailable` 等“连接不可用”错误时，主动释放该地址的连接，让下一次请求重新 Dial 并重新解析地址。

### B. 健康检查接口

- 增加 `/api/healthz`（无需登录）：
  - 检查：是否已安装、DB ping、调度器是否已启动、并发队列占用、gRPC 连接池大小等。
  - 通过 HTTP 状态码区分健康/不健康（200/503），方便 NAS/Docker 侧做 healthcheck。

## 验证与回归

- 本地运行单测与基础构建：
  - `go test ./...`
- 针对 gRPC 自愈：
  - 模拟 worker 短暂不可达后恢复，确认 master 不需要重启也能继续下发任务（至少不会卡死在旧连接上）。
