# 容器控制实现方案

## 目标

- 通过在容器内挂载 /var/run/docker.sock 与宿主数据卷，实现调度系统对 Docker 容器的启动、停止与更新控制。

## 结论

- 仅挂载套接字与数据卷并不能自动赋能控制能力，容器内必须具备调用 Docker 引擎的能力（Docker CLI 或使用 Docker SDK 的程序）。
- 推荐方案为在 gocron-node（工作节点）上以 Shell 任务直接调用宿主上的 docker 命令；备选方案为在 gocron 服务内使用 Go Docker SDK 通过套接字调用。

## 实现路径

- 路径 A（推荐）：在 gocron-node 上使用 Shell 任务执行 docker 命令
  - 优点：简单稳定、无需修改服务镜像；直接复用宿主已安装的 Docker。
  - 条件：工作节点机器已安装 Docker，并且 gocron-node 以非 root 权限也可访问 docker（配置组权限）。
- 路径 B：在 gocron 服务内使用 Go Docker SDK 调用 /var/run/docker.sock
  - 优点：接口化参数控制、可做细粒度审计。
  - 条件：容器内挂载 /var/run/docker.sock，代码中使用 SDK 创建与管理容器。
- 路径 C：启用 Docker TCP API（TLS）或集成 Portainer/Webhook
  - 优点：跨主机调用；缺点：需额外安全配置与维护。

## Compose 变更

- 已在 docker-compose.yml 为 gocron 服务添加：
  - /var/run/docker.sock:/var/run/docker.sock
  - /vol1/1000:/vol1/1000
- 作用：容器内可访问宿主 Docker 引擎与持久化数据目录。

## 路径 A 详细步骤（Shell 任务）

- 在需要控制的宿主部署 gocron-node，并确保该宿主已安装并可执行 docker。
- 在 Web 创建定时任务，类型选 Shell，命令填写 docker 操作。
- 示例（拉取并运行容器，使用挂载卷）：

```bash
docker pull nginx:stable
docker stop my-nginx || true
docker rm my-nginx || true
docker run -d --name my-nginx -p 8080:80 -v /vol1/1000:/usr/share/nginx/html nginx:stable
```

## 路径 B 详细步骤（Go SDK）

- 在服务端新增使用 Docker SDK 的任务执行器，使用套接字 unix:///var/run/docker.sock。
- 代码示例（最小可用创建并启动容器）：

```go
package main

import (
	"context"
	"github.com/docker/docker/api/types/container"
	"github.com/docker/docker/api/types/network"
	"github.com/docker/docker/api/types/strslice"
	"github.com/docker/docker/client"
)

func main() {
	ctx := context.Background()
	cli, _ := client.NewClientWithOpts(client.WithHost("unix:///var/run/docker.sock"), client.WithAPIVersionNegotiation())

	resp, _ := cli.ContainerCreate(ctx, &container.Config{
		Image: "nginx:stable",
		Cmd:   strslice.StrSlice{},
		Env:   []string{},
	}, &container.HostConfig{
		Binds:      []string{"/vol1/1000:/usr/share/nginx/html"},
		PortBindings: map[nat.Port][]nat.PortBinding{
			"80/tcp": {{HostPort: "8080"}},
		},
	}, &network.NetworkingConfig{}, nil, "my-nginx")
	_ = cli.ContainerStart(ctx, resp.ID, container.StartOptions{})
}
```

## 权限与安全

- 不建议在生产直接开放 Docker TCP 端口；若必须，启用 TLS 双向认证。
- 使用 SDK 或 CLI 前，请为 gocron/gocron-node 进程配置最小权限，避免 root。
- 挂载的业务数据卷需明确读写范围，避免误删或越权。

## Windows 注意事项

- Windows 上的 Docker 套接字为 npipe:////./pipe/docker_engine，Linux 套接字路径为 /var/run/docker.sock。
- 若在 Windows 开发而在 Linux 部署，建议以 Linux 宿主为目标环境进行验证。

## 验证流程

- 启动 Compose，进入 Web 创建测试任务（路径 A）。
- 观察目标宿主上容器状态与日志，验证启动、重启、删除等操作。
- 若采用路径 B，编译并运行新增执行器，验证通过 SDK 创建与启动容器。
